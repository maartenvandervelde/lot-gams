---
title: "Lab 2: Random Effects"
author: "Maarten van der Velde"
output: html_notebook
---

# 1. Preparation
```{r}
library(mgcv)
library(itsadug)
library(plyr)
library(dplyr)
library(colorspace)
```


Load mousetracking data
```{r}
download.file("http://www.jacolienvanrij.com/Courses/LOT2018/data/MT_dat.rda", "MT_dat.rda")
load("MT_dat.rda")
```

Order the data
```{r}
d <- arrange(dat, subject, trial, Time)
```

Every subject has multiple measurements per trial:
```{r}
d %>%
  group_by(subject, trial) %>%
  tally()
```

Number of trials per subject:
```{r}
trial_count <- d %>%
  group_by(subject) %>%
  summarise(n_trials = length(unique(trial))) %>%
  arrange(n_trials)

trial_count
summary(trial_count$n_trials)
```

## Question 1: inspection of data

**How many participants?**
```{r}
length(unique(d$subject))
```

**Average number of trials per participant?**
```{r}
mean(trial_count$n_trials)
```

---

# 2. Visualisation of the data

Plot difference in mouse trajectory by answer ("same" or "different") and the answer's location on screen (left or right).
```{r}
# Calculate averages:
dat$timebin <- timeBins(dat$Time, 5)
avg <- ddply(dat, c("location.same", "answer", "timebin"), summarise,
                  meanMT = mean(dist.target, na.rm=TRUE))

emptyPlot(range(avg$timebin), range(avg$meanMT), v0=0,
          xlab="Time (normalised)", ylab="Distance to target")

with(avg[avg$location.same=="R" & avg$answer == "SAME",], lines(timebin, meanMT, col="steelblue", lwd=2))
with(avg[avg$location.same=="L" & avg$answer == "SAME",], lines(timebin, meanMT, col="steelblue", lwd=2, lty=2))

with(avg[avg$location.same=="R" & avg$answer == "DIFFERENT",], lines(timebin, meanMT, col="red", lwd=2))
with(avg[avg$location.same=="L" & avg$answer == "DIFFERENT",], lines(timebin, meanMT, col="red", lwd=2, lty=2))

legend('topright', legend=c("R - SAME", "L - SAME", "R - DIFFERENT", "L - DIFFERENT"),
       ncol=2, 
       col=rep(c("steelblue", "red"), each=2), lwd=2, lty=rep(c(1,2), 2), bty='n')

```


---

# 3. Model 1: fixed-effects model

## Question 2: size of data

**Do we use gam or bam?**
```{r}
nrow(dat)
dim(dat)
```

Given the size of the data set, we use bam.

Model the mouse trajectories (as quantified in distance from the target) as predicted by time, modulated by the location of the "same" answer on screen, and the answer that is given.
```{r}
d <- d %>%
  mutate(location.same = as.factor(location.same), # Ensure that the predictors are coded as factors
         answer = as.factor(answer),
         loc_ans_interaction = interaction(location.same, answer))

m1 <- bam(dist.target ~ loc_ans_interaction + s(Time, by = loc_ans_interaction), data = d, method = "fREML", discrete = TRUE)
summary(m1)
```


Plot the summed effects:
```{r}
plot_smooth(m1, view = "Time", plot_all = "interaction")
```

